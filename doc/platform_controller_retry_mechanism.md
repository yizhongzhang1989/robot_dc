# Platform Controller ç»§ç”µå™¨é‡è¯•æœºåˆ¶å‡çº§

## æ¦‚è¿°

å°† `lift_robot_controller.py` ä¸­çš„ç»§ç”µå™¨æ§åˆ¶ä»åŸºäºå®šæ—¶å™¨çš„ç›²è„‰å†²æœºåˆ¶å‡çº§ä¸º**ç«‹å³æ£€æµ‹+é‡è¯•**æœºåˆ¶ï¼Œæé«˜å¯é æ€§å¹¶æ·»åŠ å¤±è´¥ä¿æŠ¤ã€‚

## å‡çº§æ—¥æœŸ
2024å¹´ï¼ˆæ ¹æ®æµ‹è¯•è„šæœ¬éªŒè¯æ—¶é—´ï¼‰

## æ ¸å¿ƒå˜åŒ–

### 1. åŸå§‹æœºåˆ¶ï¼ˆå·²åºŸå¼ƒï¼‰
```python
# æ—§æ–¹å¼ï¼šç›²å®šæ—¶å™¨è„‰å†²
def flash_relay(relay_address, duration_ms=100):
    open_relay(relay_address)  # æ‰“å¼€ç»§ç”µå™¨
    Timer(100ms, close_relay)  # 100msåå…³é—­
    # é—®é¢˜ï¼šæ— éªŒè¯ï¼Œä¸çŸ¥é“æ˜¯å¦æˆåŠŸ
```

### 2. æ–°æœºåˆ¶ï¼ˆå½“å‰å®ç°ï¼‰
```python
# æ–°æ–¹å¼ï¼šç«‹å³æ£€æµ‹+é‡è¯•
def flash_relay(relay_address, duration_ms=100, seq_id=None):
    # Phase 1: æ‰“å¼€ç»§ç”µå™¨ (æœ€å¤š3æ¬¡é‡è¯•)
    for attempt in 1..3:
        write_relay(ON)
        sleep(10ms)  # ç¡¬ä»¶å“åº”æ—¶é—´
        if read_status() == ON:
            break  # æˆåŠŸ
    
    if not turned_on:
        trigger_emergency_reset()  # 3æ¬¡å¤±è´¥åç´§æ€¥å¤ä½
        return False
    
    # Phase 2: å…³é—­ç»§ç”µå™¨ (æœ€å¤š3æ¬¡é‡è¯•)
    for attempt in 1..3:
        write_relay(OFF)
        sleep(10ms)
        if read_status() == OFF:
            break  # æˆåŠŸ
    
    if not turned_off:
        trigger_emergency_reset()  # 3æ¬¡å¤±è´¥åç´§æ€¥å¤ä½
        return False
    
    return True  # æˆåŠŸå®Œæˆ
```

## æ–°å¢æ–¹æ³•

### 1. `read_relay_status()` - è¯»å–ç»§ç”µå™¨çŠ¶æ€
```python
def read_relay_status(self):
    """
    ä½¿ç”¨ Modbus FC01 (Read Coils) è¯»å–ç»§ç”µå™¨ 0, 1, 2 çš„çŠ¶æ€
    
    Returns:
        [relay0_status, relay1_status, relay2_status]
        True=ON, False=OFF
        None=è¯»å–å¤±è´¥
    """
```

**Modbus å¸§æ ¼å¼**:
- è®¾å¤‡ID: 50 (0x32)
- åŠŸèƒ½ç : 0x01 (Read Coils)
- èµ·å§‹åœ°å€: 0x0000 (Relay 0)
- æ•°é‡: 0x0003 (è¯»3ä¸ªç»§ç”µå™¨)
- ç¤ºä¾‹å‘½ä»¤: `32 01 00 00 00 03 [CRC]`
- å“åº”: `response.response = [0, 1, 0]` (åˆ—è¡¨ï¼Œéä½æ©ç )

### 2. `write_relay_verified()` - éªŒè¯å†™å…¥
```python
def write_relay_verified(self, relay_address, value):
    """
    å†™å…¥ç»§ç”µå™¨å¹¶ç«‹å³éªŒè¯
    
    Args:
        relay_address: 0=STOP, 1=UP, 2=DOWN
        value: 0x0000=OFF, 0xFF00=ON
    
    Returns:
        bool: True=æˆåŠŸéªŒè¯, False=å¤±è´¥
    """
```

**æµç¨‹**:
1. å‘é€ FC05 å†™å…¥æŒ‡ä»¤
2. å»¶æ—¶ 10ms (ç¡¬ä»¶å“åº”æ—¶é—´)
3. è¯»å–çŠ¶æ€éªŒè¯
4. è¿”å›éªŒè¯ç»“æœ

### 3. `_trigger_emergency_reset()` - ç´§æ€¥å¤ä½
```python
def _trigger_emergency_reset(self, seq_id, reason):
    """
    3æ¬¡é‡è¯•å¤±è´¥åè§¦å‘ç´§æ€¥å¤ä½
    
    æ­¥éª¤:
    1. è®¾ç½® reset_in_progress æ ‡å¿—
    2. ç¦ç”¨æ‰€æœ‰æ§åˆ¶æ¨¡å¼
    3. å–æ¶ˆæ‰€æœ‰å®šæ—¶å™¨
    4. å¤ä½æ‰€æœ‰ç»§ç”µå™¨
    5. å‘é€ç‰©ç† STOP è„‰å†²
    6. è®¾ç½®ç³»ç»ŸçŠ¶æ€ä¸º emergency_stop
    7. é‡Šæ”¾ç³»ç»Ÿé”
    """
```

## æ€§èƒ½æŒ‡æ ‡

### æˆåŠŸæƒ…å†µï¼ˆç¬¬1æ¬¡å°è¯•æˆåŠŸï¼‰
- ON æ£€æµ‹æ—¶é—´: ~140-150ms
- OFF æ£€æµ‹æ—¶é—´: ~280-300ms
- **æ€»å®Œæˆæ—¶é—´: ~280-300ms**

### å¤±è´¥é‡è¯•ï¼ˆæœ€åæƒ…å†µï¼‰
- æœ€å¤š3æ¬¡ ON å°è¯•: æ¯æ¬¡ ~150ms â†’ æœ€å¤š 450ms
- æœ€å¤š3æ¬¡ OFF å°è¯•: æ¯æ¬¡ ~150ms â†’ æœ€å¤š 450ms
- **æœ€åæ€»æ—¶é—´: ~900ms + ç´§æ€¥å¤ä½æ—¶é—´**

## å¯é æ€§æå‡

| ç‰¹æ€§ | æ—§æœºåˆ¶ | æ–°æœºåˆ¶ |
|------|--------|--------|
| çŠ¶æ€éªŒè¯ | âŒ æ—  | âœ… æ¯æ¬¡æ“ä½œåéªŒè¯ |
| å¤±è´¥æ£€æµ‹ | âŒ ä¸çŸ¥é“ | âœ… å®æ—¶æ£€æµ‹ |
| é‡è¯•æœºåˆ¶ | âŒ æ—  | âœ… æœ€å¤š3æ¬¡é‡è¯• |
| å¤±è´¥å¤„ç† | âŒ é™é»˜å¤±è´¥ | âœ… ç´§æ€¥å¤ä½ |
| æ—¥å¿—è®°å½• | âš ï¸ åŸºæœ¬ | âœ… è¯¦ç»†ï¼ˆæ¯æ¬¡å°è¯•ï¼‰ |
| ç¡¬ä»¶å“åº”æ—¶é—´ | âŒ ç›²ç­‰100ms | âœ… ä»…ç­‰10msåéªŒè¯ |

## ç»§ç”µå™¨æ˜ å°„ï¼ˆä¸å˜ï¼‰

| ç»§ç”µå™¨åœ°å€ | åŠŸèƒ½ | ON æŒ‡ä»¤ | OFF æŒ‡ä»¤ |
|------------|------|---------|----------|
| 0 (0x0000) | STOP | `32 05 00 00 FF 00 [CRC]` | `32 05 00 00 00 00 [CRC]` |
| 1 (0x0001) | UP   | `32 05 00 01 FF 00 [CRC]` | `32 05 00 01 00 00 [CRC]` |
| 2 (0x0002) | DOWN | `32 05 00 02 FF 00 [CRC]` | `32 05 00 02 00 00 [CRC]` |

## é”™è¯¯å¤„ç†æµç¨‹

```
flash_relay() è°ƒç”¨
    â†“
Phase 1: Turn ON
    â†“
å°è¯• 1 â†’ å¤±è´¥
    â†“
å°è¯• 2 â†’ å¤±è´¥
    â†“
å°è¯• 3 â†’ å¤±è´¥
    â†“
âŒ 3æ¬¡å¤±è´¥
    â†“
ğŸ”´ trigger_emergency_reset()
    â”œâ”€ è®¾ç½® task_state = 'emergency_stop'
    â”œâ”€ è®¾ç½® completion_reason = 'relay_failure: UP relay ON failure'
    â”œâ”€ å–æ¶ˆæ‰€æœ‰å®šæ—¶å™¨
    â”œâ”€ å¤ä½æ‰€æœ‰ç»§ç”µå™¨
    â”œâ”€ å‘é€ STOP è„‰å†²
    â””â”€ é‡Šæ”¾ç³»ç»Ÿé”
```

## å½±å“çš„æ–¹æ³•

æ‰€æœ‰ä»¥ä¸‹æ–¹æ³•ç°åœ¨ä½¿ç”¨æ–°çš„é‡è¯•æœºåˆ¶ï¼š

1. **`stop(seq_id)`** - åœæ­¢è¿åŠ¨
   - è°ƒç”¨ `flash_relay(0)` (Relay 0 è„‰å†²)
   - 3æ¬¡å¤±è´¥åç´§æ€¥å¤ä½

2. **`up(seq_id)`** - å‘ä¸Šè¿åŠ¨
   - è°ƒç”¨ `flash_relay(1)` (Relay 1 è„‰å†²)
   - 3æ¬¡å¤±è´¥åç´§æ€¥å¤ä½

3. **`down(seq_id)`** - å‘ä¸‹è¿åŠ¨
   - è°ƒç”¨ `flash_relay(2)` (Relay 2 è„‰å†²)
   - 3æ¬¡å¤±è´¥åç´§æ€¥å¤ä½

4. **`timed_up(duration, seq_id)`** - å®šæ—¶å‘ä¸Š
   - å†…éƒ¨è°ƒç”¨ `up()`ï¼Œç»§æ‰¿é‡è¯•æœºåˆ¶

5. **`timed_down(duration, seq_id)`** - å®šæ—¶å‘ä¸‹
   - å†…éƒ¨è°ƒç”¨ `down()`ï¼Œç»§æ‰¿é‡è¯•æœºåˆ¶

6. **`force_up_start(seq_id)`** - åŠ›æ§å‘ä¸Šå¯åŠ¨
   - å†…éƒ¨è°ƒç”¨ `up()`ï¼Œç»§æ‰¿é‡è¯•æœºåˆ¶

7. **`force_down_start(seq_id)`** - åŠ›æ§å‘ä¸‹å¯åŠ¨
   - å†…éƒ¨è°ƒç”¨ `down()`ï¼Œç»§æ‰¿é‡è¯•æœºåˆ¶

## éªŒè¯æµ‹è¯•

æµ‹è¯•è„šæœ¬: `scripts/test_relay_polling.py`

### æµ‹è¯•ç»“æœï¼ˆ2024å¹´éªŒè¯ï¼‰
```bash
# UP ç»§ç”µå™¨æµ‹è¯•
$ python3 test_relay_polling.py up
âœ… Attempt 1/3: Relay 1 is ON! (140.22ms)
âœ… Attempt 1/3: Relay 1 is OFF! (278.60ms)
âœ… UP relay flash completed successfully! Total time: 279.32ms

# DOWN ç»§ç”µå™¨æµ‹è¯•
$ python3 test_relay_polling.py down
âœ… Attempt 1/3: Relay 2 is ON! (153.17ms)
âœ… Attempt 1/3: Relay 2 is OFF! (294.72ms)
âœ… DOWN relay flash completed successfully! Total time: 296.73ms

# STOP ç»§ç”µå™¨æµ‹è¯•
$ python3 test_relay_polling.py stop
âœ… Attempt 1/3: Relay 0 is ON! (146.19ms)
âœ… Attempt 1/3: Relay 0 is OFF! (297.76ms)
âœ… STOP relay flash completed successfully! Total time: 298.53ms
```

**ç»“è®º**: 100% ç¬¬ä¸€æ¬¡å°è¯•æˆåŠŸç‡ï¼Œå¹³å‡å®Œæˆæ—¶é—´ ~280-300ms

## é‡è¦æ³¨æ„äº‹é¡¹

### 1. ç»§ç”µå™¨è¡Œä¸ºç†è§£
- **ç»§ç”µå™¨è„‰å†² = çŠ¶æ€åˆ‡æ¢**ï¼Œä¸æ˜¯è¿åŠ¨å¢é‡
- ä¸€ä¸ª UP è„‰å†² â†’ å¹³å°**æŒç»­å‘ä¸Š**ç§»åŠ¨ï¼Œç›´åˆ°æ”¶åˆ° STOP
- ä¸€ä¸ª DOWN è„‰å†² â†’ å¹³å°**æŒç»­å‘ä¸‹**ç§»åŠ¨ï¼Œç›´åˆ°æ”¶åˆ° STOP
- ä¸€ä¸ª STOP è„‰å†² â†’ å¹³å°**åœæ­¢**è¿åŠ¨

### 2. Modbus å“åº”è§£æ
- âŒ **é”™è¯¯**: `status = response[0] & 0x01` (ä½æ©ç æ–¹å¼)
- âœ… **æ­£ç¡®**: `status = response.response[0]` (åˆ—è¡¨ç´¢å¼•æ–¹å¼)
- åŸå› : `modbus_manager_node.py` è¿”å›çš„æ˜¯åˆ—è¡¨ `[0, 1, 0]`ï¼Œä¸æ˜¯ä½æ©ç 

### 3. ModbusRequest å­—æ®µ
- âœ… ä½¿ç”¨ `req.slave_id = device_id`
- âŒ ä¸è¦ä½¿ç”¨ `req.device_id`
- âœ… å¿…é¡»è®¾ç½® `req.seq_id = 0`

### 4. ç´§æ€¥å¤ä½è§¦å‘æ¡ä»¶
- ON é˜¶æ®µ 3æ¬¡é‡è¯•å…¨éƒ¨å¤±è´¥
- OFF é˜¶æ®µ 3æ¬¡é‡è¯•å…¨éƒ¨å¤±è´¥
- flash_relay() å‘ç”Ÿå¼‚å¸¸

### 5. ç³»ç»ŸçŠ¶æ€å˜åŒ–
- ç´§æ€¥å¤ä½å `task_state` â†’ `'emergency_stop'`
- `completion_reason` â†’ `'relay_failure: <reason>'`
- éœ€è¦æ‰‹åŠ¨å¤ä½æˆ–é‡å¯æ‰èƒ½æ¢å¤

## åç»­æ”¹è¿›å»ºè®®

1. **æ·»åŠ é‡è¯•æ¬¡æ•°é…ç½®**: å…è®¸ä»å‚æ•°è°ƒæ•´æœ€å¤§é‡è¯•æ¬¡æ•°
2. **æ·»åŠ é‡è¯•é—´éš”é…ç½®**: å…è®¸è°ƒæ•´é‡è¯•ä¹‹é—´çš„å»¶æ—¶
3. **æ·»åŠ ç»Ÿè®¡ä¿¡æ¯**: è®°å½•é‡è¯•æˆåŠŸç‡å’Œå¹³å‡å°è¯•æ¬¡æ•°
4. **æ”¹è¿›ç´§æ€¥å¤ä½**: è€ƒè™‘æ›´æ¸©å’Œçš„é™çº§ç­–ç•¥ï¼ˆè­¦å‘Šä½†ä¸ç«‹å³åœæ­¢ï¼‰
5. **ç¡¬ä»¶ç›‘æ§**: å¦‚æœé‡è¯•é¢‘ç¹å‘ç”Ÿï¼Œå¯èƒ½è¡¨æ˜ç¡¬ä»¶æˆ–é€šä¿¡é—®é¢˜

## ç›¸å…³æ–‡ä»¶

- **æ ¸å¿ƒå®ç°**: `colcon_ws/src/lift_robot_platform/lift_robot_platform/lift_robot_controller.py`
- **æµ‹è¯•è„šæœ¬**: `scripts/test_relay_polling.py`
- **èŠ‚ç‚¹é€»è¾‘**: `colcon_ws/src/lift_robot_platform/lift_robot_platform/lift_robot_node.py`
- **Modbus é©±åŠ¨**: `colcon_ws/src/modbus_driver/modbus_driver/modbus_manager_node.py`

## ç‰ˆæœ¬å†å²

- **v1.0** (åŸå§‹): åŸºäºå®šæ—¶å™¨çš„ç›²è„‰å†²æœºåˆ¶ (100ms Timer)
- **v2.0** (å½“å‰): ç«‹å³æ£€æµ‹+é‡è¯•æœºåˆ¶ (æœ€å¤š3æ¬¡å°è¯• + ç´§æ€¥å¤ä½)
