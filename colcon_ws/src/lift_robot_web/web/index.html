<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>lift_robot</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { font-family: system-ui, Arial, sans-serif; }
  .dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; }
  .live { background:#10b981; }
  .stale { background:#f59e0b; }
  .disc { background:#ef4444; }
  pre { font-size:12px; }
</style>
</head>
<body class="bg-slate-100 p-4">
  <div class="max-w-2xl mx-auto space-y-4">
  <h1 class="text-xl font-bold">lift_robot</h1>
    <div class="p-3 bg-white rounded shadow space-y-2">
      <div class="text-sm flex items-center">
        <span id="stateDot" class="dot disc"></span>
        <span id="stateText">Disconnected</span>
  <span class="ml-4 text-slate-500">Mode: <span id="mode">WebSocket</span></span>
  <span class="ml-4 text-slate-500">Frequency: <span id="freq">-</span> Hz</span>
  <span class="ml-4 text-slate-500">Latency: <span id="age">-</span> ms</span>
      </div>
      <div class="flex flex-col gap-2 pt-1">
        <div class="flex gap-2">
          <span class="text-xs font-semibold text-slate-600 pr-2">Platform:</span>
          <button data-cmd="up" data-target="platform" class="px-3 py-1 bg-emerald-600 hover:bg-emerald-700 text-white text-sm rounded">Up</button>
          <button data-cmd="down" data-target="platform" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded">Down</button>
          <button data-cmd="stop" data-target="platform" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded">Stop</button>
        </div>
        <div class="flex gap-2 items-center mb-1">
          <span class="text-xs font-semibold text-slate-600 pr-2">Platform 粗调:</span>
          <input id="targetHeightPlatform" type="number" placeholder="mm" class="px-2 py-1 border border-slate-300 rounded text-sm w-20" value="750">
          <button id="gotoHeightPlatformBtn" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white text-xs rounded">Go to Height</button>
          <span class="text-xs text-slate-500">(use Stop button to cancel)</span>
        </div>
        <div class="flex gap-2 items-center mb-1">
          <span class="text-xs font-semibold text-slate-600 pr-2">Pushrod 微调:</span>
          <input id="targetHeightPushrod" type="number" placeholder="mm" class="px-2 py-1 border border-slate-300 rounded text-sm w-20" value="750">
          <button id="gotoHeightPushrodBtn" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white text-xs rounded">Go to Height</button>
          <span class="text-xs text-slate-500">(fine adjustment)</span>
        </div>
        <div class="flex flex-wrap gap-2 items-center mb-1">
          <span class="text-xs font-semibold text-slate-600 pr-2">Pushrod Points:</span>
          <button data-cmd="goto_point" data-target="pushrod" data-point="base" class="px-3 py-1 bg-slate-500 hover:bg-slate-600 text-white text-xs rounded">Base</button>
          <button data-cmd="goto_point" data-target="pushrod" data-point="only forward" class="px-3 py-1 bg-emerald-500 hover:bg-emerald-600 text-white text-xs rounded">Only Forward (3.5s)</button>
          <button data-cmd="goto_point" data-target="pushrod" data-point="safe mode" class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded">Safe Mode (2.7s)</button>
          <button data-cmd="goto_point" data-target="pushrod" data-point="fwd&back" class="px-3 py-1 bg-purple-500 hover:bg-purple-600 text-white text-xs rounded">Fwd&Back (4.5s)</button>
          <button data-cmd="goto_point" data-target="pushrod" data-point="all direction" class="px-3 py-1 bg-orange-500 hover:bg-orange-600 text-white text-xs rounded">All Direction (5.0s)</button>
        </div>
        <div class="flex flex-wrap gap-2 items-center">
          <span class="text-xs font-semibold text-slate-600 pr-2">Pushrod Manual:</span>
          <button data-cmd="up" data-target="pushrod" class="px-3 py-1 bg-emerald-600 hover:bg-emerald-700 text-white text-xs rounded">Up</button>
          <button data-cmd="down" data-target="pushrod" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded">Down</button>
          <button data-cmd="stop" data-target="pushrod" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded">Stop</button>
        </div>
  <span id="cmdStatus" class="text-xs text-slate-500"></span>
      </div>
      <div class="grid grid-cols-2 gap-2 text-sm">
        <div>register_0: <span id="reg0" class="font-mono">-</span></div>
        <div>register_1: <span id="reg1" class="font-mono">-</span></div>
        <div>seq_id: <span id="seq" class="font-mono">-</span></div>
        <div>device_id: <span id="device" class="font-mono">-</span></div>
        <div>raw height (mm): <span id="rawHeight" class="font-mono">-</span></div>
        <div>pushrod offset (mm): <span id="pushrodOffset" class="font-mono">-</span></div>
        <div class="col-span-2">adjusted height (mm): <span id="heightVal" class="font-mono font-semibold">-</span></div>
        <div class="col-span-2">pushrod point: <span id="pushrodPoint" class="font-mono">-</span></div>
      </div>
  <div class="text-sm text-slate-600">Last message timestamp: <span id="ts">-</span></div>
    </div>
    <div class="p-3 bg-white rounded shadow space-y-2">
      <h2 class="font-semibold">Force Sensors</h2>
      <div class="grid grid-cols-2 gap-2 text-sm">
        <div>Right (CH2): <span id="rightForce" class="font-mono">-</span></div>
        <div>Left (CH3): <span id="leftForce" class="font-mono">-</span></div>
      </div>
      <div class="text-xs text-slate-500" id="forceTs">-</div>
    </div>
    <div class="bg-white p-3 rounded shadow">
      <h2 class="font-semibold mb-2">Raw JSON</h2>
      <pre id="raw" class="bg-slate-50 p-2 rounded max-h-72 overflow-auto"></pre>
    </div>
  </div>
<script>
let ws=null, lastReceive=null; let intervals=[]; let usePolling=false; let pollTimer=null; let readInterval=1000;
function $(id){return document.getElementById(id);} 
function setState(type,text){ const d=$('stateDot'); d.className='dot '+type; $('stateText').textContent=text; }
function connect(){ const proto=location.protocol==='https:'?'wss':'ws'; ws=new WebSocket(proto+'://'+location.host+'/ws'); ws.onopen=()=>{usePolling=false; $('mode').textContent='WebSocket'; setState('live','Live'); if(pollTimer){clearInterval(pollTimer);} }; ws.onmessage=e=>{ if(e.data==='ping') return; handle(e.data); }; ws.onclose=()=>{ setState('disc','Disconnected'); fallback(); setTimeout(connect,3000); }; ws.onerror=()=> setState('disc','Error'); }
function fallback(){ if(usePolling) return; usePolling=true; $('mode').textContent='Polling'; pollTimer=setInterval(async()=>{ try{ const r=await fetch('/api/latest'); if(!r.ok) return; handle(JSON.stringify(await r.json())); }catch(e){} }, 1000); }
function handle(raw){ lastReceive=Date.now(); $('raw').textContent=raw; try{ const data=JSON.parse(raw); update(data); setState('live','Live'); }catch(e){} }
function update(d){
  if(d.register_0!==undefined) $('reg0').textContent=d.register_0;
  if(d.register_1!==undefined) $('reg1').textContent=d.register_1;
  if(d.seq_id!==undefined) $('seq').textContent=d.seq_id;
  if(d.device_id!==undefined) $('device').textContent=d.device_id;
  if(d.timestamp){ $('ts').textContent=d.timestamp; }
  if(d.read_interval){ readInterval=d.read_interval*1000; }
  if(d.raw_height!==undefined){ $('rawHeight').textContent = (d.raw_height===null?'-':(d.raw_height.toFixed?d.raw_height.toFixed(2):d.raw_height)); }
  if(d.pushrod_offset_mm!==undefined){ $('pushrodOffset').textContent = (d.pushrod_offset_mm===null?'-':(d.pushrod_offset_mm.toFixed?d.pushrod_offset_mm.toFixed(1):d.pushrod_offset_mm)); }
  if(d.height!==undefined){ $('heightVal').textContent = (d.height===null?'-':(d.height.toFixed?d.height.toFixed(2):d.height)); }
  if(d.pushrod_point!==undefined){ $('pushrodPoint').textContent = d.pushrod_point; }
  if(d.right_force_sensor!==undefined){ $('rightForce').textContent=(d.right_force_sensor===null?'-':d.right_force_sensor.toFixed?d.right_force_sensor.toFixed(3):d.right_force_sensor); }
  if(d.left_force_sensor!==undefined){ $('leftForce').textContent=(d.left_force_sensor===null?'-':d.left_force_sensor.toFixed?d.left_force_sensor.toFixed(3):d.left_force_sensor); }
  if(d.right_force_sensor!==undefined || d.left_force_sensor!==undefined){ $('forceTs').textContent='Updated at '+new Date().toLocaleTimeString(); }
  if(d.current_point!==undefined) $('pushrodPoint').textContent=d.current_point;
  computeFreq();
}
function computeFreq(){ intervals.push(Date.now()); if(intervals.length>25) intervals.shift(); if(intervals.length>1){ const diffs=[]; for(let i=1;i<intervals.length;i++) diffs.push(intervals[i]-intervals[i-1]); const avg=diffs.reduce((a,b)=>a+b,0)/diffs.length; $('freq').textContent=(1000/avg).toFixed(2); } }
setInterval(()=>{ if(!lastReceive){ $('age').textContent='-'; return; } const age=Date.now()-lastReceive; $('age').textContent=age; const staleThreshold=Math.max(2500,2.5*readInterval); if(age>staleThreshold){ setState('stale','Stale'); } },500);
connect();

// Command buttons
document.querySelectorAll('button[data-cmd]').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const command=btn.getAttribute('data-cmd');
    const target=btn.getAttribute('data-target')||'platform';
    const durationAttr=btn.getAttribute('data-duration');
  const duration=durationAttr?parseFloat(durationAttr):undefined;
  const point=btn.getAttribute('data-point');
    $('cmdStatus').textContent='Sending '+command+' ...';
    const payload={command,target};
  if(duration!==undefined) payload.duration=duration;
  if(point) payload.point=point;
    try {
      const r=await fetch('/api/cmd',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      if(!r.ok){ $('cmdStatus').textContent='Failed '+command; return; }
      const resp=await r.json();
      $('cmdStatus').textContent='Done '+command+(resp.duration?(' ('+resp.duration+'s)'):'');
      setTimeout(()=>$('cmdStatus').textContent='',2000);
    } catch(e){ $('cmdStatus').textContent='Error'; }
  });
});

// Go to Height button (special handler with input field)
$('gotoHeightPlatformBtn').addEventListener('click', async ()=>{
  const targetHeight = parseFloat($('targetHeightPlatform').value);
  if(isNaN(targetHeight)){
    $('cmdStatus').textContent='Invalid height value';
    setTimeout(()=>$('cmdStatus').textContent='',2000);
    return;
  }
  $('cmdStatus').textContent='Platform going to '+targetHeight+'mm ...';
  const payload={command:'goto_height',target:'platform',target_height:targetHeight};
  try {
    const r=await fetch('/api/cmd',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!r.ok){ $('cmdStatus').textContent='Failed goto_height (platform)'; return; }
    const resp=await r.json();
    $('cmdStatus').textContent='Platform moving to '+targetHeight+'mm';
    setTimeout(()=>$('cmdStatus').textContent='',3000);
  } catch(e){ $('cmdStatus').textContent='Error'; }
});

// Pushrod fine adjustment button
$('gotoHeightPushrodBtn').addEventListener('click', async ()=>{
  const targetHeight = parseFloat($('targetHeightPushrod').value);
  if(isNaN(targetHeight)){
    $('cmdStatus').textContent='Invalid height value';
    setTimeout(()=>$('cmdStatus').textContent='',2000);
    return;
  }
  $('cmdStatus').textContent='Pushrod fine-tuning to '+targetHeight+'mm ...';
  const payload={command:'goto_height',target:'pushrod',target_height:targetHeight};
  try {
    const r=await fetch('/api/cmd',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!r.ok){ $('cmdStatus').textContent='Failed goto_height (pushrod)'; return; }
    const resp=await r.json();
    $('cmdStatus').textContent='Pushrod fine-tuning to '+targetHeight+'mm';
    setTimeout(()=>$('cmdStatus').textContent='',3000);
  } catch(e){ $('cmdStatus').textContent='Error'; }
});
</script>
</body>
</html>
