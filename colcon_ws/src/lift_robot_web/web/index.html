<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>lift_robot</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { font-family: system-ui, Arial, sans-serif; }
  .dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; }
  .live { background:#10b981; }
  .stale { background:#f59e0b; }
  .disc { background:#ef4444; }
  pre { font-size:12px; }
</style>
</head>
<body class="bg-slate-100 p-4">
  <div class="max-w-2xl mx-auto space-y-4">
  <h1 class="text-xl font-bold">lift_robot</h1>
    <div class="p-3 bg-white rounded shadow space-y-2">
      <div class="text-sm flex items-center">
        <span id="stateDot" class="dot disc"></span>
        <span id="stateText">Disconnected</span>
  <span class="ml-4 text-slate-500">Mode: <span id="mode">WebSocket</span></span>
  <span class="ml-4 text-slate-500">Frequency: <span id="freq">-</span> Hz</span>
  <span class="ml-4 text-slate-500">Latency: <span id="age">-</span> ms</span>
      </div>
      <div class="flex flex-col gap-2 pt-1">
        <div class="flex gap-2">
          <span class="text-xs font-semibold text-slate-600 pr-2">Platform:</span>
          <button data-cmd="up" data-target="platform" class="px-3 py-1 bg-emerald-600 hover:bg-emerald-700 text-white text-sm rounded">Up</button>
          <button data-cmd="down" data-target="platform" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded">Down</button>
          <button data-cmd="stop" data-target="platform" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded">Stop</button>
        </div>
        <div class="flex gap-2 items-center mb-1">
          <span class="text-xs font-semibold text-slate-600 pr-2">Platform 粗调:</span>
          <input id="targetHeightPlatform" type="number" placeholder="mm" class="px-2 py-1 border border-slate-300 rounded text-sm w-20" value="750">
          <button id="gotoHeightPlatformBtn" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white text-xs rounded">Go to Height</button>
          <span class="text-xs text-slate-500">(use Stop button to cancel)</span>
        </div>
        <div class="flex gap-2 items-center mb-1">
          <span class="text-xs font-semibold text-slate-600 pr-2">Pushrod 微调:</span>
          <input id="targetHeightPushrod" type="number" placeholder="mm" class="px-2 py-1 border border-slate-300 rounded text-sm w-20" value="750">
          <button id="gotoHeightPushrodBtn" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white text-xs rounded">Go to Height</button>
          <span class="text-xs text-slate-500">(fine adjustment)</span>
        </div>
        <div class="flex flex-wrap gap-2 items-center mb-1">
          <span class="text-xs font-semibold text-slate-600 pr-2">Pushrod:</span>
          <button data-cmd="goto_point" data-target="pushrod" data-point="base" class="px-3 py-1 bg-slate-500 hover:bg-slate-600 text-white text-xs rounded">Go to Base</button>
        </div>
        <div class="flex flex-wrap gap-2 items-center">
          <span class="text-xs font-semibold text-slate-600 pr-2">Pushrod Manual:</span>
          <button data-cmd="up" data-target="pushrod" class="px-3 py-1 bg-emerald-600 hover:bg-emerald-700 text-white text-xs rounded">Up</button>
          <button data-cmd="down" data-target="pushrod" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded">Down</button>
          <button data-cmd="stop" data-target="pushrod" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded">Stop</button>
        </div>
  <span id="cmdStatus" class="text-xs text-slate-500"></span>
      </div>
      <div class="grid grid-cols-2 gap-2 text-sm">
  <div>seq_id: <span id="seq" class="font-mono">-</span></div>
  <div>height (mm): <span id="heightVal" class="font-mono font-semibold">-</span></div>
  <div>Height Freq: <span id="heightFreq" class="font-mono">-</span> Hz</div>
  <div>Height Latency: <span id="heightLatency" class="font-mono">-</span> ms</div>
      </div>
  <div class="text-sm text-slate-600">Last message timestamp: <span id="ts">-</span></div>
    </div>
    <div class="p-3 bg-white rounded shadow space-y-2">
      <h2 class="font-semibold">Platform Status</h2>
      <div class="grid grid-cols-2 gap-2 text-sm">
        <div>Movement: <span id="platformMovement" class="font-mono">-</span></div>
        <div>Mode: <span id="platformMode" class="font-mono">-</span></div>
        <div>Current Height: <span id="platformCurrentHeight" class="font-mono">-</span> mm</div>
        <div>Target Height: <span id="platformTargetHeight" class="font-mono">-</span> mm</div>
      </div>
    </div>
    <div class="p-3 bg-white rounded shadow space-y-2">
      <h2 class="font-semibold">Pushrod Status</h2>
      <div class="grid grid-cols-2 gap-2 text-sm">
        <div>Movement: <span id="pushrodMovement" class="font-mono">-</span></div>
        <div>Mode: <span id="pushrodMode" class="font-mono">-</span></div>
        <div>Current Height: <span id="pushrodCurrentHeight" class="font-mono">-</span> mm</div>
        <div>Target Height: <span id="pushrodTargetHeight" class="font-mono">-</span> mm</div>
        <div>Offset: <span id="pushrodOffsetVal" class="font-mono font-semibold">-</span> mm</div>
        <div>Point: <span id="pushrodPoint" class="font-mono">-</span></div>
      </div>
    </div>
    <div class="p-3 bg-white rounded shadow space-y-2">
      <h2 class="font-semibold">Force Sensors (Calibrated)</h2>
      <div class="grid grid-cols-2 gap-2 text-sm">
        <div>Right Force (N): <span id="rightForceVal" class="font-mono font-semibold">-</span></div>
        <div>Left Force (N): <span id="leftForceVal" class="font-mono font-semibold">-</span></div>
      </div>
      <div class="text-xs text-slate-500">
        <div>Right: device_id=52, /force_sensor</div>
        <div>Left: device_id=53, /force_sensor_2</div>
      </div>
      <div class="text-xs text-slate-500" id="forceTs">-</div>
    </div>
    <div class="bg-white p-3 rounded shadow">
      <h2 class="font-semibold mb-2">Raw JSON</h2>
      <pre id="raw" class="bg-slate-50 p-2 rounded max-h-72 overflow-auto"></pre>
    </div>
  </div>
<script>
let ws=null, lastReceive=null; let intervals=[]; let usePolling=false; let pollTimer=null; let readInterval=1000;
function $(id){return document.getElementById(id);} 
function setState(type,text){ const d=$('stateDot'); d.className='dot '+type; $('stateText').textContent=text; }
function connect(){ const proto=location.protocol==='https:'?'wss':'ws'; ws=new WebSocket(proto+'://'+location.host+'/ws'); ws.onopen=()=>{usePolling=false; $('mode').textContent='WebSocket'; setState('live','Live'); if(pollTimer){clearInterval(pollTimer);} }; ws.onmessage=e=>{ if(e.data==='ping') return; handle(e.data); }; ws.onclose=()=>{ setState('disc','Disconnected'); fallback(); setTimeout(connect,3000); }; ws.onerror=()=> setState('disc','Error'); }
function fallback(){ if(usePolling) return; usePolling=true; $('mode').textContent='Polling'; pollTimer=setInterval(async()=>{ try{ const r=await fetch('/api/latest'); if(!r.ok) return; handle(JSON.stringify(await r.json())); }catch(e){} }, 1000); }
function handle(raw){ lastReceive=Date.now(); $('raw').textContent=raw; try{ const data=JSON.parse(raw); update(data); setState('live','Live'); }catch(e){} }
function update(d){
  // Compact mode fields
  if(d.seq_id!==undefined) $('seq').textContent=d.seq_id;
  if(d.height!==undefined) $('heightVal').textContent = (d.height===null?'-':(d.height.toFixed?d.height.toFixed(2):d.height));
  if(d.freq_hz!==undefined) $('heightFreq').textContent = (d.freq_hz && d.freq_hz.toFixed? d.freq_hz.toFixed(2): d.freq_hz);
  if(d.latency_ms!==undefined && d.latency_ms!==null) $('heightLatency').textContent = (d.latency_ms.toFixed? d.latency_ms.toFixed(1): d.latency_ms);
  // Legacy fallback (timestamp / read_interval)
  if(d.timestamp){ $('ts').textContent=d.timestamp; }
  if(d.read_interval){ readInterval=d.read_interval*1000; }
  
  // Dual channel force sensors (right=device_id 52, left=device_id 53)
  if(d.right_force_sensor!==undefined) {
    $('rightForceVal').textContent = (d.right_force_sensor===null?'-':(d.right_force_sensor.toFixed?d.right_force_sensor.toFixed(2):d.right_force_sensor));
    $('forceTs').textContent='Updated at '+new Date().toLocaleTimeString();
  }
  if(d.left_force_sensor!==undefined) {
    $('leftForceVal').textContent = (d.left_force_sensor===null?'-':(d.left_force_sensor.toFixed?d.left_force_sensor.toFixed(2):d.left_force_sensor));
    $('forceTs').textContent='Updated at '+new Date().toLocaleTimeString();
  }
  
  // Platform status
  if(d.platform_status){
    const ps = d.platform_status;
    if(ps.movement_state!==undefined) $('platformMovement').textContent=ps.movement_state;
    if(ps.control_mode!==undefined) $('platformMode').textContent=ps.control_mode;
    if(ps.current_height!==undefined) $('platformCurrentHeight').textContent=(ps.current_height.toFixed?ps.current_height.toFixed(2):ps.current_height);
    if(ps.target_height!==undefined) $('platformTargetHeight').textContent=(ps.target_height.toFixed?ps.target_height.toFixed(2):ps.target_height);
  }
  
  // Pushrod status
  if(d.pushrod_status){
    const prs = d.pushrod_status;
    if(prs.movement_state!==undefined) $('pushrodMovement').textContent=prs.movement_state;
    if(prs.control_mode!==undefined) $('pushrodMode').textContent=prs.control_mode;
    if(prs.current_height!==undefined) $('pushrodCurrentHeight').textContent=(prs.current_height.toFixed?prs.current_height.toFixed(2):prs.current_height);
    if(prs.target_height!==undefined) $('pushrodTargetHeight').textContent=(prs.target_height.toFixed?prs.target_height.toFixed(2):prs.target_height);
    if(prs.pushrod_offset!==undefined) $('pushrodOffsetVal').textContent=(prs.pushrod_offset.toFixed?prs.pushrod_offset.toFixed(2):prs.pushrod_offset);
    if(prs.current_point!==undefined) $('pushrodPoint').textContent=prs.current_point;
  }
  
  computeFreq();
}
function computeFreq(){ intervals.push(Date.now()); if(intervals.length>25) intervals.shift(); if(intervals.length>1){ const diffs=[]; for(let i=1;i<intervals.length;i++) diffs.push(intervals[i]-intervals[i-1]); const avg=diffs.reduce((a,b)=>a+b,0)/diffs.length; $('freq').textContent=(1000/avg).toFixed(2); } }
setInterval(()=>{ if(!lastReceive){ $('age').textContent='-'; return; } const age=Date.now()-lastReceive; $('age').textContent=age; const staleThreshold=Math.max(2500,2.5*readInterval); if(age>staleThreshold){ setState('stale','Stale'); } },500);
connect();

// Command buttons
document.querySelectorAll('button[data-cmd]').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const command=btn.getAttribute('data-cmd');
    const target=btn.getAttribute('data-target')||'platform';
    const durationAttr=btn.getAttribute('data-duration');
  const duration=durationAttr?parseFloat(durationAttr):undefined;
  const point=btn.getAttribute('data-point');
    $('cmdStatus').textContent='Sending '+command+' ...';
    const payload={command,target};
  if(duration!==undefined) payload.duration=duration;
  if(point) payload.point=point;
    try {
      const r=await fetch('/api/cmd',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      if(!r.ok){ $('cmdStatus').textContent='Failed '+command; return; }
      const resp=await r.json();
      $('cmdStatus').textContent='Done '+command+(resp.duration?(' ('+resp.duration+'s)'):'');
      setTimeout(()=>$('cmdStatus').textContent='',2000);
    } catch(e){ $('cmdStatus').textContent='Error'; }
  });
});

// Go to Height button (special handler with input field)
$('gotoHeightPlatformBtn').addEventListener('click', async ()=>{
  const targetHeight = parseFloat($('targetHeightPlatform').value);
  if(isNaN(targetHeight)){
    $('cmdStatus').textContent='Invalid height value';
    setTimeout(()=>$('cmdStatus').textContent='',2000);
    return;
  }
  $('cmdStatus').textContent='Platform going to '+targetHeight+'mm ...';
  const payload={command:'goto_height',target:'platform',target_height:targetHeight};
  try {
    const r=await fetch('/api/cmd',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!r.ok){ $('cmdStatus').textContent='Failed goto_height (platform)'; return; }
    const resp=await r.json();
    $('cmdStatus').textContent='Platform moving to '+targetHeight+'mm';
    setTimeout(()=>$('cmdStatus').textContent='',3000);
  } catch(e){ $('cmdStatus').textContent='Error'; }
});

// Pushrod fine adjustment button
$('gotoHeightPushrodBtn').addEventListener('click', async ()=>{
  const targetHeight = parseFloat($('targetHeightPushrod').value);
  if(isNaN(targetHeight)){
    $('cmdStatus').textContent='Invalid height value';
    setTimeout(()=>$('cmdStatus').textContent='',2000);
    return;
  }
  $('cmdStatus').textContent='Pushrod fine-tuning to '+targetHeight+'mm ...';
  const payload={command:'goto_height',target:'pushrod',target_height:targetHeight};
  try {
    const r=await fetch('/api/cmd',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!r.ok){ $('cmdStatus').textContent='Failed goto_height (pushrod)'; return; }
    const resp=await r.json();
    $('cmdStatus').textContent='Pushrod fine-tuning to '+targetHeight+'mm';
    setTimeout(()=>$('cmdStatus').textContent='',3000);
  } catch(e){ $('cmdStatus').textContent='Error'; }
});
</script>
</body>
</html>
